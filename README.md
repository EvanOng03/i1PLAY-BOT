# Telegram 群组管理与消息群发机器人

这是一个功能强大的 Telegram 机器人，可以帮助您管理多个群组并向这些群组批量发送消息。

## 功能特点

### 群组管理
- 自动记录机器人被邀请的群组信息
- 手动添加群组
- 创建和管理群组分类
- 为群组添加备注
- 导出群组列表为 CSV/Excel 格式

### 消息群发
- 支持向全部群组、特定分类或选定群组发送消息
- 支持发送文本、图片、视频和文件
- **新增：多文件批量发送功能**
- **新增：支持在一次群发中发送多条不同类型的消息**
- **新增：智能速率控制与并发群发（更快更稳）**
- **新增：定时/倒计时群发（/schedule_send, /timer_send）**
- **新增：任务列表查看（/list_tasks, /tasks）**
- 详细的发送结果报告
- 记录群发历史

### 权限控制
- 仅允许管理员使用管理功能
- 通过环境变量配置管理员列表
- **新增：白名单管理系统**
- **新增：支持群组和私聊用户的权限控制**
- **新增：管理员可动态管理白名单**

## 安装与设置

### 前提条件
- Python 3.7 或更高版本
- 已创建的 Telegram Bot 和 API Token

### 安装步骤

1. 下载本项目文件到您的计算机或服务器

2. 安装依赖包
   ```
   pip install -r requirements.txt
   ```

3. 配置环境变量
   - 编辑 `.env` 文件，填入您的 Bot Token 和管理员 ID
   ```
   BOT_TOKEN=your_bot_token_here
   ADMIN_IDS=123456789,987654321
   ```

4. 运行机器人
   ```
   python bot.py
   ```

## 使用指南

### 基本命令

- `/start` - 启动机器人
- `/help` - 显示帮助信息

### 群组管理命令

- `/listgroups` - 查看所有已记录的群组
- `/addgroup <chat_id>` - 手动添加群组
- `/addcategory <分类名>` - 新建分类
- `/assign <chat_id> <分类名>` - 将群分配至指定分类
- `/rename <chat_id> <备注>` - 给群设置备注

### 消息群发命令

- `/send` - 启动消息群发流程
  1. 选择目标范围（全部群组/某个分类/特定群组）
  2. 发送要群发的消息（文本/图片/视频/文件）
  3. **新增：可选择继续添加更多消息或完成发送**
  4. 确认发送

#### 发送优化（说明）
- 智能速率控制：每个群组独立限速，动态延迟，提升吞吐并避免封禁。
- 并发群发：跨群组并行发送，单群组内有序发送以避免触发限制。
- 错误与重试：网络异常与速率限制有保护，日志可查看每次发送结果。

### 定时/倒计时群发命令（新）

- `/schedule_send` - 启动定时群发流程（输入北京时间）
  1. 选择目标（全部/分类/指定群组）
  2. 发送要群发的消息，可多条不同类型
  3. 选择"完成添加"
  4. 输入计划执行时间（北京时间，例如：`2025-01-12 15:30` 或 `2025/01/12 15:30`）
  5. 确认创建并等待到点执行
  - 时间说明：输入为北京时间（GMT+8），系统内部自动转换为 `UTC` 存储与调度。

- `/timer_send` - 启动倒计时群发流程（输入时长）
  1. 选择目标（全部/分类/指定群组）
  2. 发送要群发的消息，可多条不同类型
  3. 选择"完成添加"
  4. 输入倒计时（支持 `1H 30M 15S`、`90M`、`3600S`、`HH:MM:SS` 等格式）
  5. 确认创建并等待倒计时结束执行

### 权限管理命令

- `/whitelist` - 管理白名单（仅管理员可用）
  - 查看当前白名单状态
  - 添加/移除群组ID
  - 添加/移除用户ID

### 日志与导出命令

- `/logs <N>` - 查看最近 N 次群发记录
- `/export` - 导出群组清单为 CSV/Excel 格式
- `/botlog` - 查看操作记录
- `/exportbotlog` - 导出操作记录为 CSV
- `/exportbotlogjson` - 导出原始操作日志 JSON

### 任务查看命令（新）

- `/list_tasks` - 查看任务列表（默认仅显示待执行任务，管理员可用）
- `/list_tasks all` 或 `/list_tasks 全部` - 查看全部任务（含已完成/已取消）
- `/tasks` - `/list_tasks` 的别名

### 删除消息命令（新）

- `/delete` - 打开删除主菜单（不限制时间窗口）
  - 快速操作：显示最近3次群发，可一键“全删”或“选择群组”删除
  - 智能筛选：按群组名称/别名搜索（模糊匹配），直接对匹配项删除
  - 搜索支持多关键词分隔：使用 `/`、`,`、`，` 或空格分隔多个关键字（OR 逻辑）
  - 详细列表：分页展示近记录，每条可“全删”或进入群组选择并批量删除

#### 删除优化（说明）
- 并发删除：跨群组并行删除，单群组内遵循速率限制，整体速度更快。
- 精准控制：支持单群组、批量选择、整批次删除，满足不同场景。
- 无时间窗口过滤：展示所有已记录的群发批次；如平台限制导致删除失败，会在结果中提示。

#### 删除操作示例
1. 使用 `/delete` 打开菜单
2. 选择“查看详细列表”，翻页查看需要的批次并点击“全删”或“选择”
3. 在“选择群组”界面勾选目标群组，点击“删除选中”
4. 或者点击“按群组名称搜索”，输入关键字后在结果列表中删除

## 使用流程示例

### 群组管理流程

1. 将机器人添加到您的 Telegram 群组中
2. 机器人会自动记录群组信息
3. 使用 `/listgroups` 查看已记录的群组
4. 使用 `/addcategory 重要群组` 创建一个分类
5. 使用 `/assign -1001234567890 重要群组` 将群组分配到该分类
6. 使用 `/rename -1001234567890 公司官方群` 为群组添加备注

### 消息群发流程

#### 单条消息群发
1. 使用 `/send` 命令启动群发流程
2. 从菜单中选择目标范围（例如：特定分类或全部群组）
3. 发送您要群发的消息（可以是文本、图片、视频或文件）
4. 选择"完成添加"
5. 确认发送
6. 查看发送结果报告

#### 多条消息批量群发（新功能）
1. 使用 `/send` 命令启动群发流程
2. 从菜单中选择目标范围
3. 发送第一条消息（文本、图片、视频或文件）
4. 选择"继续添加消息"
5. 发送第二条消息（可以是不同类型）
6. 重复步骤4-5，添加更多消息
7. 选择"完成添加"
8. 确认发送所有消息
9. 查看详细的发送结果报告

### 定时群发流程（新）
1. 使用 `/schedule_send` 启动定时群发
2. 选择目标（全部/分类/指定群组）
3. 发送要群发的消息，可多条不同类型
4. 选择"完成添加"
5. 输入计划执行时间（北京时间，示例：`2025-01-12 15:30`）
6. 确认创建并等待到点执行

### 倒计时群发流程（新）
1. 使用 `/timer_send` 启动倒计时群发
2. 选择目标（全部/分类/指定群组）
3. 发送要群发的消息，可多条不同类型
4. 选择"完成添加"
5. 输入倒计时（支持 `1H 30M 15S`、`90M`、`3600S`、`HH:MM:SS` 等）
6. 确认创建并等待倒计时结束执行

## 注意事项

- 确保机器人在目标群组中拥有发送消息的权限
- 大规模群发可能受到 Telegram API 限制，建议控制发送频率
- 定期备份 `data` 目录中的数据文件
- 删除功能不做时间窗口限制；批量删除逐条执行，如平台限制导致删除失败，会在结果中显示失败条数。
- 定时时间输入使用北京时间（GMT+8），系统内部转换为 `UTC` 存储与调度；若输入时间已过将提示重新输入。
- 倒计时支持多种格式（如 `HH:MM:SS`、`90M`、`1H 30M`、`3600S`）；格式错误会提示重新输入。

## 故障排除

- 如果机器人无法发送消息，请检查它是否有足够的权限
- 如果无法添加群组，请确保提供的 chat_id 正确
- 如果管理命令无效，请确认您的用户 ID 已添加到管理员列表中
- 如果“查看详细列表/搜索/选择群组”无响应，请确保机器人已更新并重启；查看日志中的“收到删除回调”记录以定位问题。
- `/schedule_send` 输入的时间格式错误或早于当前时间时，系统会提示重新输入；请使用北京时间格式如 `YYYY-MM-DD HH:MM`。
- `/timer_send` 倒计时格式不符合要求会提示重试；支持 `HH:MM:SS`、`1H 30M`、`90M`、`3600S` 等。
- `/list_tasks` 无法查看到任务时，请确认自己为管理员；默认仅显示待执行任务，查看全部可使用 `all` 或 `全部` 参数。

## 未来功能计划

- 周期性定时任务：可设定每天固定时间自动群发消息（重复任务）
- Web 管理后台：提供可视化操作界面，替代命令方式进行群组与消息管理